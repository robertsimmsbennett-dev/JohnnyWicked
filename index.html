<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Johnny Wicked Survivors</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background: #000000;
            color: #d1d1d1;
            font-family: 'Chakra Petch', monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            flex-direction: column;
        }
        
        #gameContainer {
            position: relative;
            /* Base width and height, will be scaled by JS */
            width: 900px;
            height: 700px;
            background: #0a0a0a;
            border: 3px solid #333;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            overflow: hidden;
            box-sizing: border-box;
            transform-origin: center center; /* Ensure scaling is centered */
        }

        canvas {
            display: block;
            background-color: #000000;
            image-rendering: pixelated;
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud-item {
            position: absolute;
            /* Keep absolute for precise placement within UI overlay */
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px; /* Will be scaled by JS */
            text-shadow: 1px 1px 2px #000;
            border: 1px solid #333;
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        /* Top Left Controls: Score and Pause Button */
        #top-left-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            /* Will be scaled by JS */
            pointer-events: all;
        }

        /* Bottom Left Controls: Time, Menu, and Level */
        #bottom-left-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            /* Will be scaled by JS */
            pointer-events: all;
        }

        #score-display {
            position: static;
            margin-bottom: 5px;
        }
        
        #time-display {
            position: static;
            margin-bottom: 5px;
            display: block;
        }
        
        #level-display {
            position: static;
        }
        
        #xp-bar-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px; /* Will be scaled by JS */
            height: 15px;
            /* Will be scaled by JS */
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 7.5px;
            overflow: hidden;
        }
        
        #xp-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #66ccff, #3399ff);
            transition: width 0.2s ease-out;
        }

        #ultimate-bar-container {
            position: absolute;
            bottom: 30px; /* Will be scaled by JS */
            left: 50%;
            transform: translateX(-50%);
            width: 300px; /* Will be scaled by JS */
            height: 10px;
            /* Will be scaled by JS */
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
        }
        
        #ultimate-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #ffcc00, #ff6600);
        }

        #message-box, .menu, #level-select-menu, #character-select-menu, #options-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ffff;
            padding: 20px;
            /* Will be scaled by JS */
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em; /* Will be scaled by JS */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            display: none;
            pointer-events: all;
            z-index: 11;
            /* Make menus responsive */
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        #power-selection {
            display: flex;
            gap: 20px; /* Will be scaled by JS */
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px; /* Will be scaled by JS */
        }

        .power-card, .character-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #00ffff;
            padding: 15px; /* Will be scaled by JS */
            width: 160px;
            /* Will be scaled by JS */
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: left;
            pointer-events: all;
            box-sizing: border-box;
        }
        
        .power-card:hover, .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
        }
        
        .power-card h4, .character-card h3 {
            margin-top: 0;
            color: #00ffff;
            display: flex;
            justify-content: space-between;
        }
        
        .power-card p, .character-card p {
            font-size: 0.8em;
            /* Will be scaled by JS */
            margin-bottom: 0;
        }

        .menu button, .control-button, #level-select-menu button, #character-select-menu button, #options-menu button { 
            background: linear-gradient(45deg, #ff0000, #990000);
            color: #d1d1d1;
            border: none;
            padding: 15px 30px; /* Will be scaled by JS */
            font-size: 1.2em;
            /* Will be scaled by JS */
            font-family: 'Chakra Petch', monospace;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            /* Will be scaled by JS */
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4);
            white-space: nowrap;
        }
        
        .menu button:hover, .control-button:hover, #level-select-menu button:hover, #character-select-menu button:hover, #options-menu button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.6);
        }
        
        .menu button.active-option {
            background: linear-gradient(45deg, #00ffff, #009999);
            color: #000;
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.6);
            transform: translateY(-3px) scale(1.05);
        }

        #pauseButton, #menuButton, #muteMusicButton, #resumeFromMenuButton, #backToMainMenuButtonFromGame { 
            padding: 8px 15px;
            /* Will be scaled by JS */
            font-size: 1em;
            /* Will be scaled by JS */
            margin-top: 0;
            background: linear-gradient(45deg, #007bff, #0056b3);
            box-shadow: 0 3px 10px rgba(0, 123, 255, 0.4);
        }

        #pauseButton:hover, #menuButton:hover, #muteMusicButton:hover, #resumeFromMenuButton:hover, #backToMainMenuButtonFromGame:hover {
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.6);
        }

        #ultimate-button {
            position: absolute;
            bottom: 20px; /* Will be scaled by JS */
            right: 20px;
            /* Will be scaled by JS */
            pointer-events: all;
            background: #ff6600;
            color: #fff;
            border: none;
            padding: 10px 20px; /* Will be scaled by JS */
            font-size: 1.2em;
            /* Will be scaled by JS */
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.5);
            transition: all 0.3s ease;
            opacity: 0.5;
            transform: scale(0.9);
        }

        #ultimate-button.ready {
            background: linear-gradient(45deg, #ffcc00, #ff6600);
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.8);
            transform: scale(1);
            opacity: 1;
        }

        .damage-number {
            position: absolute;
            color: #ff0000;
            font-size: 10px; /* Will be scaled by JS */
            font-weight: bold;
            text-shadow: 1px 1px 1px #000;
            animation: fadeOutUp 1s forwards;
            pointer-events: none;
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeOutAndShrink 0.8s forwards;
        }

        @keyframes fadeOutAndShrink {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0);
            }
        }

        #high-score-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ffff;
            padding: 30px;
            /* Will be scaled by JS */
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            z-index: 20;
            display: none;
            pointer-events: all;
            max-width: 90%;
            box-sizing: border-box;
        }

        #high-score-modal input {
            background-color: #1a1a1a;
            border: 1px solid #00ffff;
            color: #d1d1d1;
            padding: 10px; /* Will be scaled by JS */
            margin: 15px 0;
            /* Will be scaled by JS */
            border-radius: 5px;
            width: 80%;
            max-width: 250px; /* Will be scaled by JS */
            font-family: 'Chakra Petch', monospace;
            font-size: 1em; /* Will be scaled by JS */
        }

        #high-score-modal button {
            background: linear-gradient(45deg, #00ffff, #009999);
            color: #000;
            border: none;
            padding: 10px 20px; /* Will be scaled by JS */
            font-size: 1em;
            /* Will be scaled by JS */
            font-family: 'Chakra Petch', monospace;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
            /* Will be scaled by JS */
        }

        #high-score-modal button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 255, 255, 0.4);
        }

        #high-scores-list, #start-menu-high-scores-list {
            list-style: none;
            padding: 0;
            margin-top: 20px; /* Will be scaled by JS */
            max-height: 200px;
            /* Will be scaled by JS */
            overflow-y: auto;
            text-align: left;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            /* Will be scaled by JS */
            background-color: rgba(0, 0, 0, 0.5);
            font-size: 0.9em; /* Will be scaled by JS */
        }

        #high-scores-list li, #start-menu-high-scores-list li {
            padding: 5px 0;
            border-bottom: 1px dashed #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #high-scores-list li:last-child, #start-menu-high-scores-list li:last-child {
            border-bottom: none;
        }
        #high-scores-list li span, #start-menu-high-scores-list li span {
            color: #00ffff;
            font-weight: bold;
        }

        /* Level Select Menu Styles */
        .level-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #00ffff;
            padding: 15px; /* Will be scaled by JS */
            width: 250px;
            /* Will be scaled by JS */
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            pointer-events: all;
            margin-bottom: 15px;
            /* Will be scaled by JS */
            box-sizing: border-box;
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .level-card.locked:hover {
            transform: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .level-card h3 {
            margin-top: 0;
            color: #00ffff;
            font-size: 1.5em; /* Will be scaled by JS */
        }

        .level-card p {
            font-size: 1em;
            /* Will be scaled by JS */
            margin-bottom: 5px;
        }

        .level-card .unlock-info {
            color: #ffdd00;
            font-size: 0.8em; /* Will be scaled by JS */
            font-weight: bold;
        }

        /* Mini-map styles */
        #miniMapContainer {
            position: absolute;
            top: 10px; /* Will be scaled by JS */
            right: 10px;
            /* Will be scaled by JS */
            width: 150px;
            /* Will be scaled by JS */
            height: 150px;
            /* Will be scaled by JS */
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            border-radius: 10px;
            overflow: hidden;
            z-index: 10;
            pointer-events: none;
        }

        #miniMapCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    
        /* Responsive font sizes using vw units */
        @media (max-width: 900px) {
            /* General font scaling for smaller screens */
            .hud-item, .menu, #high-score-modal, .power-card, .character-card,
            .menu button, .control-button, #ultimate-button,
            #high-score-modal input, #high-score-modal button,
            #high-scores-list, #start-menu-high-scores-list,
            .level-card, .level-card h3, .level-card p, .level-card .unlock-info {
                font-size: clamp(0.7em, 2.5vw, 1.2em);
                /* Fluid font size */
                padding: clamp(5px, 1.5vw, 15px) clamp(10px, 3vw, 30px);
                margin-top: clamp(10px, 2vw, 20px);
                margin-bottom: clamp(5px, 1vw, 15px);
            }
            #xp-bar-container, #ultimate-bar-container {
                width: clamp(200px, 50vw, 300px);
                height: clamp(10px, 1.5vw, 15px);
            }
            #ultimate-bar-container {
                bottom: clamp(15px, 4vw, 30px);
            }
            #ultimate-button {
                bottom: clamp(10px, 3vw, 20px);
                right: clamp(10px, 3vw, 20px);
            }
            #miniMapContainer {
                width: clamp(100px, 20vw, 150px);
                height: clamp(100px, 20vw, 150px);
                top: clamp(5px, 1.5vw, 10px);
                right: clamp(5px, 1.5vw, 10px);
            }
            .power-card, .character-card {
                width: clamp(120px, 25vw, 160px);
            }
            .level-card {
                width: clamp(200px, 40vw, 250px);
            }
            #top-left-controls, #bottom-left-controls {
                top: clamp(5px, 1.5vw, 10px);
                left: clamp(5px, 1.5vw, 10px);
                gap: clamp(3px, 0.8vw, 5px);
            }
            #bottom-left-controls {
                bottom: clamp(5px, 1.5vw, 10px);
                left: clamp(5px, 1.5vw, 10px);
            }
            #high-score-modal input {
                max-width: clamp(150px, 40vw, 250px);
            }
        }
    </style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
        <div id="top-left-controls">
            <div class="hud-item" id="score-display">Score: 0</div>
            <button class="control-button" id="pauseButton">Pause</button>
        </div>
        <div id="bottom-left-controls">
            <div class="hud-item" id="time-display">Time: 0s</div>
            <button class="control-button" id="menuButton">Menu</button>
            <div class="hud-item" id="level-display">Level: 1</div>
        </div>
        <div id="miniMapContainer">
            <canvas id="miniMapCanvas"></canvas>
        </div>
        <div id="xp-bar-container"><div id="xp-bar"></div></div>
        <div id="ultimate-bar-container"><div id="ultimate-bar"></div></div>
        <button id="ultimate-button">Wicked Mode</button>
    </div>
    <div class="menu" id="start-menu">
        <h1>JOHNNY WICKED SURVIVORS</h1>
        <p>Click or tap anywhere to move. Your character will fire automatically.</p>
        <p>New: Enemies can now shoot back! Be careful of the gunmen.</p>
        <button id="startButton">Start Game</button>
        <button id="levelSelectButton">Level Select</button>
        <button id="optionsButton">Options</button>
        <button id="autoPlayButton">Play for Me</button>
        <h3>Global High Scores</h3>
        <ul id="start-menu-high-scores-list">
        </ul>
    </div>
    <div class="menu" id="options-menu" style="display: none;">
        <h1>Options</h1>
        <p>Choose your display ratio:</p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button class="ratio-option" data-ratio="21:9" id="ratio21_9">Vertical 21:9 (iPhone & Android)</button>
            <button class="ratio-option" data-ratio="1:1" id="ratio1_1">Square 1:1</button>
            <button class="ratio-option" data-ratio="4:3" id="ratio4_3">Classic 4:3 (Folding Phones)</button>
        </div>
        <button id="backToStartMenuFromOptions">Back</button>
    </div>
    <div class="menu" id="game-over-menu" style="display: none;">
        <h1>GAME OVER</h1>
        <h2 id="final-score">Score: 0</h2>
        <h2 id="final-time">Time Survived: 0s</h2>
        <h2 id="final-level">Level Reached: 1</h2>
        <h3>High Scores</h3>
        <ul id="high-scores-list">
        </ul>
        <button id="restartButton">Restart Game</button>
        <button id="backToMainMenuButtonGameOver">Return to Main Menu</button>
    </div>
    <div class="menu" id="message-box" style="display: none;">
        <h3 id="message-title">Level Up!</h3>
        <p id="message-text">Choose your power-up:</p>
        <div id="power-selection"></div>
    </div>
    <div class="menu" id="game-menu" style="display: none;">
        <h1>Game Menu</h1>
        <button class="control-button" id="muteMusicButton">Mute Music</button>
        <button class="control-button" id="resumeFromMenuButton">Resume Game</button>
        <button class="control-button" id="backToMainMenuButtonFromGame">Back to Main Menu</button>
    </div>
    <div id="high-score-modal" style="display: none;">
        <h3>New High Score!</h3>
        <p>Enter your name:</p>
        <input id="playerNameInput" type="text" placeholder="Your Name" maxlength="15"/>
        <button id="saveScoreButton">Save Score</button>
    </div>
    <div class="menu" id="level-select-menu" style="display: none;">
        <h1>Select Level</h1>
        <div id="level-options">
        </div>
        <button id="backToMainMenuButton">Back</button>
    </div>
    <div class="menu" id="character-select-menu" style="display: none;">
        <h1>Select Your Survivor</h1>
        <div id="character-options" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px;">
            <div class="character-card" data-character="johnny">
                <h3>Johnny Wicked</h3>
                <p>Classic survivor, balanced abilities.</p>
                <p>Starting Weapon: Pistol</p>
            </div>
            <div class="character-card" data-character="dixie">
                <h3>Dixie</h3>
                <p>Dog whisperer, commands loyal companions.</p>
                <p>Starting Weapon: Twin Uzis + 1 Dog Ally</p>
            </div>
        </div>
        <button id="backToStartMenuFromCharSelect">Back</button>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<script>
    // --- Local Storage High Score System ---

    // Saves a high score to local storage.
    window.saveHighScoreLocally = function(name, score, time, level, levelId) {
        try {
            const highScores = JSON.parse(localStorage.getItem('jws_highScores') || '[]');
            const newScore = {
                name: name,
                score: score,
                survivalTime: time,
                level: level,
                levelId: levelId,
                timestamp: Date.now()
            };
            highScores.push(newScore);
            highScores.sort((a, b) => b.score - a.score); // Sort descending
            const topScores = highScores.slice(0, 10); // Keep only top 10
            localStorage.setItem('jws_highScores', JSON.stringify(topScores));
            console.log("High score saved locally!");
        } catch (e) {
            console.error("Error saving high score locally: ", e);
        }
    };

    // Retrieves high scores from local storage.
    window.getHighScoresLocally = function() {
        try {
            const highScores = JSON.parse(localStorage.getItem('jws_highScores') || '[]');
            console.log("[Local Get] Fetched high score data:", highScores);
            return highScores;
        } catch (e) {
            console.error("Error getting documents from local storage: ", e);
            return [];
        }
    };

    // Saves the user's best score for a specific level.
    window.saveUserLevelScoreLocally = function(levelId, score) {
        try {
            const levelScores = JSON.parse(localStorage.getItem('jws_levelScores') || '{}');
            const currentBestScore = levelScores[levelId] || 0;

            if (score > currentBestScore) {
                levelScores[levelId] = score;
                localStorage.setItem('jws_levelScores', JSON.stringify(levelScores));
                console.log(`User's highest score for ${levelId} updated locally to ${score}.`);
            }
        } catch (e) {
            console.error(`Error saving user level score locally for ${levelId}: `, e);
        }
    };

    // Loads the user's best score for a specific level.
    window.loadUserLevelScoreLocally = function(levelId) {
        try {
            const levelScores = JSON.parse(localStorage.getItem('jws_levelScores') || '{}');
            return levelScores[levelId] || 0;
        } catch (e) {
            console.error(`Error loading user level score locally for ${levelId}: `, e);
            return 0;
        }
    };
</script>
<script>
    // Get canvas and UI elements from the DOM
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const gameContainer = document.getElementById('gameContainer');
    const startMenu = document.getElementById('start-menu');
    const gameOverMenu = document.getElementById('game-over-menu');
    const messageBox = document.getElementById('message-box');
    const powerSelectionDiv = document.getElementById('power-selection');
    const ultimateButton = document.getElementById('ultimate-button');
    const highScoreModal = document.getElementById('high-score-modal');
    const playerNameInput = document.getElementById('playerNameInput');
    const saveScoreButton = document.getElementById('saveScoreButton');
    const highScoresList = document.getElementById('high-scores-list');
    const startMenuHighScoresList = document.getElementById('start-menu-high-scores-list');
    const pauseButton = document.getElementById('pauseButton'); 
    const menuButton = document.getElementById('menuButton');     
    const gameMenu = document.getElementById('game-menu');
    const autoPlayButton = document.getElementById('autoPlayButton');
    const resumeFromMenuButton = document.getElementById('resumeFromMenuButton'); 
    const levelSelectButton = document.getElementById('levelSelectButton'); 
    const levelSelectMenu = document.getElementById('level-select-menu'); 
    const levelOptionsDiv = document.getElementById('level-options');
    const backToMainMenuButton = document.getElementById('backToMainMenuButton'); 
    const backToMainMenuButtonFromGame = document.getElementById('backToMainMenuButtonFromGame'); 
    const characterSelectMenu = document.getElementById('character-select-menu'); 
    const characterOptionsDiv = document.getElementById('character-options'); 
    const backToStartMenuFromCharSelect = document.getElementById('backToStartMenuFromCharSelect');
    const backToMainMenuButtonGameOver = document.getElementById('backToMainMenuButtonGameOver');
    const optionsButton = document.getElementById('optionsButton');
    const optionsMenu = document.getElementById('options-menu');
    const backToStartMenuFromOptions = document.getElementById('backToStartMenuFromOptions');
    const ratioButtons = document.querySelectorAll('.ratio-option');

    const scoreDisplay = document.getElementById('score-display');
    const timeDisplay = document.getElementById('time-display');
    const levelDisplay = document.getElementById('level-display');
    const xpBar = document.getElementById('xp-bar');
    const ultimateBar = document.getElementById('ultimate-bar');

    // --- Mini-map elements ---
    const miniMapCanvas = document.getElementById('miniMapCanvas');
    const miniMapCtx = miniMapCanvas.getContext('2d');
    const miniMapContainer = document.getElementById('miniMapContainer');

    // Game state variables
    let player, enemies, projectiles, powerups, obstacles, chests, allyDogs, drones, boomerangs;
    let camera, gameWorld, currentLevelId, gameSpeedMultiplier;
    let lastTime = 0;
    let isPaused = true;
    let isGameOver = false;
    let survivalTime = 0;
    let gameLoopFrame;
    let ultimateActive = false;
    let ultimateCooldown = 0;
    let ultimateDuration = 0;
    let screenFlash = { active: false, duration: 0, alpha: 0 };
    let playerInput = { x: 0, y: 0 };
    let isMobile = false; // Flag to detect mobile devices
    let mobileControlsVisible = false;

    // Joysticks and touch state (removed)
    // Audio and music setup
    let backgroundMusic;
    let isMusicMuted = false;
    let savedVolume = 0.5;

    // Level data
    const levels = [
        {
            id: 'hotel_lobby',
            name: 'Hotel Lobby',
            obstacles: [
                // Obstacle generation code
            ],
            enemyWaves: [
                // Enemy wave data
            ]
        },
        {
            id: 'the_park',
            name: 'The Park',
            obstacles: [],
            enemyWaves: []
        },
        {
            id: 'desert_oasis',
            name: 'Desert Oasis',
            obstacles: [],
            enemyWaves: []
        },
        {
            id: 'factory_realm',
            name: 'Factory Realm',
            obstacles: [],
            enemyWaves: []
        }
    ];

    const characters = {
        johnny: {
            name: 'Johnny Wicked',
            stats: {
                health: 100,
                baseDamage: 10,
                speed: 150,
                fireRate: 0.5,
                magnetRange: 150,
                damageReduction: 0,
                lucky: 0.1,
                ultimateCharge: 0,
                ultimateChargeRate: 0.005,
                ultimateChargeRequired: 100
            }
        },
        dixie: {
            name: 'Dixie',
            stats: {
                health: 120,
                baseDamage: 8,
                speed: 130,
                fireRate: 0.4,
                magnetRange: 120,
                damageReduction: 0.1,
                lucky: 0.15,
                ultimateCharge: 0,
                ultimateChargeRate: 0.006,
                ultimateChargeRequired: 100
            }
        }
    };
    let selectedCharacterId = 'johnny';

    // Power-up definitions
    const MAX_UPGRADE_LEVEL = 10;
    const powerupDefinitions = [
        // Power-up data
    ];

    let shootTimer = 0;
    let spawnTimer = 0;
    let ultimateChargePerHit = 0.5;
    let lastShotSoundTime = 0;
    let lastEnemyHitSoundTime = 0;
    const enemyHitSoundCooldown = 0.05;
    let currentAspectRatio = localStorage.getItem('jws_aspectRatio') || '1:1'; // Load or default

    // Tone.js audio setup (only for sound effects, music removed)
    let playerSynth, enemyHitSynth, levelUpSynth, ultimateSynth, gameOverSynth, explosionSound;
    
    // Helper function to calculate distance
    function dist(a, b) {
        return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));
    }

    // --- Collision Resolution Functions ---
    // Resolves collision between two circles (e.g., player/enemy and pillar)
    function circleCircleCollideAndResolve(c1, c2) {
        // ... (existing code)
    }

    // Resolves collision between a circle and a rectangle (e.g., player/enemy and desk/chair)
    function circleRectCollideAndResolve(circle, rect) {
        // ... (existing code)
    }

    // --- End Collision Resolution Functions ---

    // Function to play sound effects
    function playSound(type) {
        // ... (existing code)
    }

    function setupAudio() {
        // ... (existing code)
    }

    function draw() {
        // ... (existing code)
    }

    function drawScreenFlash() {
        // ... (existing code)
    }

    function drawBackground() {
        // ... (existing code)
    }

    function drawObstacles() {
        // ... (existing code)
    }
    
    function drawProjectiles() {
        // ... (existing code)
    }

    function drawPowerups() {
        // ... (existing code)
    }

    function drawChests() {
        // ... (existing code)
    }

    function drawEnemies() {
        // ... (existing code)
    }

    function drawPlayer() {
        // ... (existing code)
    }

    function drawSpinningKnives() {
        // ... (existing code)
    }
    
    function drawAllyDogs() {
        // ... (existing code)
    }

    function drawDrones() {
        // ... (existing code)
    }

    function drawBoomerangs() {
        // ... (existing code)
    }

    function drawUltimateEffect() {
        // ... (existing code)
    }

    function drawForcefield() {
        // ... (existing code)
    }

    function drawAcidAura() {
        // ... (existing code)
    }

    function drawLeashWhip() {
        // ... (existing code)
    }

    function drawDamageNumbers() {
        // ... (existing code)
    }

    function drawParticles() {
        // ... (existing code)
    }

    function drawUI() {
        // ... (existing code)
    }
    
    function drawMiniMap() {
        // ... (existing code)
    }

    function resetGame() {
        // ... (existing code)
    }

    function startGame() {
        // ... (existing code)
    }

    function showLevelSelectMenu() {
        // ... (existing code)
    }

    function showCharacterSelectMenu() {
        // ... (existing code)
    }

    function showMainMenu() {
        // ... (existing code)
    }

    function showGameOverMenu() {
        // ... (existing code)
    }

    function showLevelUpMenu() {
        // ... (existing code)
    }
    
    function showOptionsMenu() {
        startMenu.style.display = 'none';
        optionsMenu.style.display = 'block';
        updateOptionsUi();
    }

    function updateOptionsUi() {
        ratioButtons.forEach(button => {
            if (button.dataset.ratio === currentAspectRatio) {
                button.classList.add('active-option');
            } else {
                button.classList.remove('active-option');
            }
        });
    }

    function setAspectRatio(ratio) {
        currentAspectRatio = ratio;
        localStorage.setItem('jws_aspectRatio', ratio);
        resizeCanvas();
        updateOptionsUi();
        console.log(`Aspect ratio set to ${ratio}.`);
    }

    function updateHud() {
        // ... (existing code)
    }

    function updateMiniMap() {
        // ... (existing code)
    }

    function update(dt) {
        // ... (existing code)
    }

    function gameLoop(timestamp) {
        // ... (existing code)
    }

    function handlePlayerMovement(dt) {
        // ... (existing code)
    }

    function checkCollisions() {
        // ... (existing code)
    }

    function handleEnemyPlayerCollisions() {
        // ... (existing code)
    }

    function handleProjectileEnemyCollisions() {
        // ... (existing code)
    }

    function handlePlayerPowerupCollisions() {
        // ... (existing code)
    }

    function handlePlayerChestCollisions() {
        // ... (existing code)
    }

    function handlePlayerObstacleCollisions() {
        // ... (existing code)
    }

    function handleEnemyObstacleCollisions() {
        // ... (existing code)
    }

    function updateEnemies(dt) {
        // ... (existing code)
    }

    function updateProjectiles(dt) {
        // ... (existing code)
    }

    function updateDrones(dt) {
        // ... (existing code)
    }

    function updateDronesEffect() {
        // ... (existing code)
    }

    function updateAllyDogs(dt) {
        // ... (existing code)
    }

    function updateBoomerangs(dt) {
        // ... (existing code)
    }

    function getEnemyBaseStats(type) {
        // ... (existing code)
    }

    function explodeRobotDrone(drone) {
        // ... (existing code)
    }

    function spawnPowerup(x, y, type) {
        // ... (existing code)
    }

    function spawnChestAtLocation(x, y) {
        // ... (existing code)
    }

    function activateChestPowerup() {
        // ... (existing code)
    }

    function applyInstantMagnetEffect() {
        // ... (existing code)
    }

    function killAllEnemiesEffect() {
        // ... (existing code)
    }

    function gainXp(amount) {
        // ... (existing code)
    }

    function levelUp() {
        // ... (existing code)
    }

    function getRandomPowerupOptions() {
        // ... (existing code)
    }

    function handlePowerupSelection(powerup) {
        // ... (existing code)
    }

    function showDamageNumber(damage, x, y) {
        // ... (existing code)
    }

    function spawnParticles(x, y, color) {
        // ... (existing code)
    }
    
    function updateParticles(dt) {
        // ... (existing code)
    }

    function gameOver() {
        // ... (existing code)
    }

    function handleUltimate() {
        // ... (existing code)
    }

    function startUltimate() {
        // ... (existing code)
    }

    function endUltimate() {
        // ... (existing code)
    }

    function resizeCanvas() {
        // The game's native resolution
        const baseWidth = 900;
        const baseHeight = 700;

        let viewportWidth, viewportHeight;
        const viewportRatio = window.innerWidth / window.innerHeight;

        let gameWidth, gameHeight;
        let scale = 1;

        // Apply selected aspect ratio
        if (currentAspectRatio === '21:9') {
            gameHeight = window.innerHeight;
            gameWidth = gameHeight * 9 / 21;
            scale = gameHeight / baseHeight;
            if (gameWidth > window.innerWidth) {
                gameWidth = window.innerWidth;
                gameHeight = gameWidth * 21 / 9;
                scale = gameWidth / baseWidth;
            }
        } else if (currentAspectRatio === '4:3') {
            gameWidth = window.innerWidth;
            gameHeight = gameWidth * 3 / 4;
            scale = gameWidth / baseWidth;
            if (gameHeight > window.innerHeight) {
                gameHeight = window.innerHeight;
                gameWidth = gameHeight * 4 / 3;
                scale = gameHeight / baseHeight;
            }
        } else { // Default to 1:1 square
            gameWidth = Math.min(window.innerWidth, window.innerHeight);
            gameHeight = gameWidth;
            scale = gameWidth / baseWidth;
        }

        gameContainer.style.width = `${gameWidth}px`;
        gameContainer.style.height = `${gameHeight}px`;

        // Adjust canvas scaling to fit the new container dimensions
        const containerRatio = gameWidth / gameHeight;
        const baseRatio = baseWidth / baseHeight;

        let finalScale = 1;
        if (containerRatio > baseRatio) {
            finalScale = gameHeight / baseHeight;
        } else {
            finalScale = gameWidth / baseWidth;
        }

        gameContainer.style.transform = `scale(${finalScale})`;

        canvas.width = baseWidth;
        canvas.height = baseHeight;
        
        console.log(`Resized canvas: ${canvas.width}x${canvas.height} with aspect ratio ${currentAspectRatio}. Container: ${gameContainer.style.width}x${gameContainer.style.height}, Scale: ${finalScale}`);
    }

    // Event Listeners
    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            pauseGame();
        }
    });

    // Touch event handlers (removed)
    // Mouse event handlers for desktop play
    gameContainer.addEventListener('mousemove', e => {
        if (!isPaused && !isGameOver) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            playerInput.x = (e.clientX - rect.left) * scaleX;
            playerInput.y = (e.clientY - rect.top) * scaleY;
        }
    });

    gameContainer.addEventListener('mouseleave', () => {
        if (!isPaused && !isGameOver) {
            playerInput.x = 0;
            playerInput.y = 0;
        }
    });

    // Button event listeners
    document.getElementById('startButton').addEventListener('click', () => {
        showCharacterSelectMenu();
    });

    document.getElementById('levelSelectButton').addEventListener('click', () => {
        showLevelSelectMenu();
    });

    document.getElementById('optionsButton').addEventListener('click', showOptionsMenu);

    document.getElementById('autoPlayButton').addEventListener('click', () => {
        // ... (existing code)
    });

    document.getElementById('restartButton').addEventListener('click', () => {
        // ... (existing code)
    });

    document.getElementById('saveScoreButton').addEventListener('click', () => {
        // ... (existing code)
    });

    document.getElementById('pauseButton').addEventListener('click', () => {
        if (!isGameOver) {
            pauseGame();
        }
    });
    
    document.getElementById('menuButton').addEventListener('click', pauseGame);

    document.getElementById('muteMusicButton').addEventListener('click', toggleMusicMute);

    document.getElementById('resumeFromMenuButton').addEventListener('click', resumeGame);

    document.getElementById('backToMainMenuButtonFromGame').addEventListener('click', showMainMenu);

    document.getElementById('backToMainMenuButton').addEventListener('click', showMainMenu);

    document.getElementById('backToMainMenuButtonGameOver').addEventListener('click', showMainMenu);

    document.getElementById('ultimate-button').addEventListener('click', handleUltimate);
    
    document.querySelectorAll('#level-options button').forEach(button => {
        button.addEventListener('click', (e) => {
            // ... (existing code)
        });
    });

    document.querySelectorAll('.character-card').forEach(card => {
        card.addEventListener('click', (e) => {
            // ... (existing code)
        });
    });
    
    document.getElementById('backToStartMenuFromCharSelect').addEventListener('click', showMainMenu);

    document.getElementById('backToStartMenuFromOptions').addEventListener('click', showMainMenu);

    ratioButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            setAspectRatio(e.target.dataset.ratio);
        });
    });

    function toggleMusicMute() {
        // ... (existing code)
    }

    function pauseGame() {
        // ... (existing code)
    }

    function resumeGame() {
        // ... (existing code)
    }

    // Initialization
    isMobile = /Mobi|Android/i.test(navigator.userAgent);
    showMainMenu();
    resizeCanvas();
    Tone.start();

</script>
</body>
</html>
