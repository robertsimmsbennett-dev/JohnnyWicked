<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johnny Wicked Survivors</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            background: #000000;
            color: #d1d1d1;
            font-family: 'Chakra Petch', monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw; /* Ensure body takes full width */
            user-select: none; /* Prevent text selection on touch */
            -webkit-tap-highlight-color: rgba(0,0,0,0); /* Remove tap highlight on iOS */
            flex-direction: column; /* For better mobile layout */
        }
        
        #gameContainer {
            position: relative;
            width: 900px; /* Base width */
            height: 700px; /* Base height */
            background: #0a0a0a;
            border: 3px solid #333;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            overflow: hidden;

            /* Responsive adjustments for gameContainer */
            max-width: 95vw; /* Max width relative to viewport */
            max-height: 95vh; /* Max height relative to viewport */
            aspect-ratio: 9 / 7; /* Maintain aspect ratio */
            box-sizing: border-box; /* Include padding and border in element's total width and height */
        }

        canvas {
            display: block;
            background-color: #000000;
            image-rendering: pixelated;
            position: relative;
            z-index: 2;
            width: 100%; /* Make canvas fill its container */
            height: 100%; /* Make canvas fill its container */
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud-item {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            text-shadow: 1px 1px 2px #000;
            border: 1px solid #333;
        }
        
        /* Top Left Controls: Score and Pause Button */
        #top-left-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            pointer-events: all; /* Allow interaction */
        }

        /* Bottom Left Controls: Time, Menu, and Level */
        #bottom-left-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            pointer-events: all; /* Allow interaction */
        }

        #score-display {
            position: static; /* Remove absolute positioning from here */
            margin-bottom: 5px; /* Space between score and pause button */
        }
        
        /* Time display now part of bottom-left-controls */
        #time-display {
            position: static; /* Remove absolute positioning from here */
            margin-bottom: 5px; /* Space between time and menu button */
            display: block; /* Ensure it's visible */
        }
        
        #level-display {
            position: static; /* Remove absolute positioning from here */
            /* No margin-bottom needed as it's the last item */
        }
        
        #xp-bar-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 7.5px;
            overflow: hidden;
        }
        
        #xp-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #66ccff, #3399ff);
            transition: width 0.2s ease-out;
        }

        #ultimate-bar-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
        }
        
        #ultimate-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #ffcc00, #ff6600);
        }

        #message-box, .menu, #level-select-menu, #character-select-menu { /* Apply menu styles to message-box, game-menu, level-select-menu, and character-select-menu */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ffff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            display: none;
            pointer-events: all;
            z-index: 11; /* Ensure menus are on top */
        }
        
        #power-selection {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .power-card, .character-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #00ffff;
            padding: 15px;
            width: 160px; /* Reduced width */
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: left;
            pointer-events: all;
        }
        
        .power-card:hover, .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
        }
        
        .power-card h4, .character-card h3 {
            margin-top: 0;
            color: #00ffff;
            display: flex;
            justify-content: space-between;
        }
        
        .power-card p, .character-card p {
            font-size: 0.7em; /* Reduced font size here */
            margin-bottom: 0;
        }

        /* General menu button styles */
        .menu button, .control-button, #level-select-menu button, #character-select-menu button { 
            background: linear-gradient(45deg, #ff0000, #990000);
            color: #d1d1d1;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            font-family: 'Chakra Petch', monospace;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4);
            white-space: nowrap; /* Prevent text wrapping */
        }
        
        .menu button:hover, .control-button:hover, #level-select-menu button:hover, #character-select-menu button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.6);
        }

        /* Specific styles for the new control buttons */
        #pauseButton, #menuButton, #muteMusicButton, #resumeFromMenuButton, #backToMainMenuButtonFromGame { 
            padding: 8px 15px; /* Smaller padding for control buttons */
            font-size: 1em; /* Smaller font size */
            margin-top: 0; /* Remove top margin */
            background: linear-gradient(45deg, #007bff, #0056b3); /* Blue gradient */
            box-shadow: 0 3px 10px rgba(0, 123, 255, 0.4);
        }

        #pauseButton:hover, #menuButton:hover, #muteMusicButton:hover, #resumeFromMenuButton:hover, #backToMainMenuButtonFromGame:hover {
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.6);
        }

        #ultimate-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            pointer-events: all;
            background: #ff6600;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 102, 0, 0.5);
            transition: all 0.3s ease;
            opacity: 0.5;
            transform: scale(0.9);
        }

        #ultimate-button.ready {
            background: linear-gradient(45deg, #ffcc00, #ff6600);
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.8);
            transform: scale(1);
            opacity: 1;
        }

        .damage-number {
            position: absolute;
            color: #ff0000;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 1px #000;
            animation: fadeOutUp 1s forwards;
            pointer-events: none;
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Particle effect styles */
        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8); /* White with some transparency */
            border-radius: 50%; /* Make them circular */
            pointer-events: none; /* Do not block mouse events */
            animation: fadeOutAndShrink 0.8s forwards; /* Animation for fading and shrinking */
        }

        @keyframes fadeOutAndShrink {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0);
            }
        }

        #high-score-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ffff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            z-index: 20;
            display: none; /* Hidden by default */
            pointer-events: all;
        }

        #high-score-modal input {
            background-color: #1a1a1a;
            border: 1px solid #00ffff;
            color: #d1d1d1;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            width: 80%;
            max-width: 250px;
            font-family: 'Chakra Petch', monospace;
            font-size: 1em;
        }

        #high-score-modal button {
            background: linear-gradient(45deg, #00ffff, #009999);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            font-family: 'Chakra Petch', monospace;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        #high-score-modal button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 255, 255, 0.4);
        }

        #high-scores-list, #start-menu-high-scores-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #high-scores-list li, #start-menu-high-scores-list li {
            padding: 5px 0;
            border-bottom: 1px dashed #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #high-scores-list li:last-child, #start-menu-high-scores-list li:last-child {
            border-bottom: none;
        }
        #high-scores-list li span, #start-menu-high-scores-list li span {
            color: #00ffff;
            font-weight: bold;
        }

        /* Level Select Menu Styles */
        .level-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #00ffff;
            padding: 15px;
            width: 250px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            pointer-events: all;
            margin-bottom: 15px; /* Space between cards */
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .level-card.locked:hover {
            transform: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .level-card h3 {
            margin-top: 0;
            color: #00ffff;
            font-size: 1.5em;
        }

        .level-card p {
            font-size: 1em;
            margin-bottom: 5px;
        }

        .level-card .unlock-info {
            color: #ffdd00;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Mini-map styles */
        #miniMapContainer {
            position: absolute;
            top: 10px;
            right: 10px; /* Position in top right */
            width: 150px; /* Fixed width */
            height: 150px; /* Fixed height to make it square */
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            border-radius: 10px;
            overflow: hidden;
            z-index: 10;
            pointer-events: none; /* Only for display, not interaction */
        }

        #miniMapCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div id="top-left-controls">
                <div id="score-display" class="hud-item">Score: 0</div>
                <button id="pauseButton" class="control-button">Pause</button>
            </div>

            <div id="bottom-left-controls">
                <div id="time-display" class="hud-item">Time: 0s</div>
                <button id="menuButton" class="control-button">Menu</button>
                <div id="level-display" class="hud-item">Level: 1</div>
            </div>

            <div id="miniMapContainer">
                <canvas id="miniMapCanvas"></canvas>
            </div>

            <div id="xp-bar-container"><div id="xp-bar"></div></div>
            <div id="ultimate-bar-container"><div id="ultimate-bar"></div></div>
            <button id="ultimate-button">Wicked Mode</button>
        </div>
        
        <div id="start-menu" class="menu">
            <h1>JOHNNY WICKED SURVIVORS</h1>
            <p>Click or tap anywhere to move. Your character will fire automatically.</p>
            <p>New: Enemies can now shoot back! Be careful of the gunmen.</p>
            <button id="startButton">Start Game</button>
            <button id="levelSelectButton">Level Select</button>
            <h3>Global High Scores</h3>
            <ul id="start-menu-high-scores-list">
                </ul>
        </div>

        <div id="game-over-menu" class="menu" style="display: none;">
            <h1>GAME OVER</h1>
            <h2 id="final-score">Score: 0</h2>
            <h2 id="final-time">Time Survived: 0s</h2>
            <h2 id="final-level">Level Reached: 1</h2>
            <h3>High Scores</h3>
            <ul id="high-scores-list">
                </ul>
            <button id="restartButton">Restart Game</button>
            <button id="backToMainMenuButtonGameOver">Return to Main Menu</button> </div>

        <div id="message-box" class="menu" style="display: none;">
            <h3 id="message-title">Level Up!</h3>
            <p id="message-text">Choose your power-up:</p>
            <div id="power-selection"></div>
        </div>

        <div id="game-menu" class="menu" style="display: none;">
            <h1>Game Menu</h1>
            <button id="muteMusicButton" class="control-button">Mute Music</button>
            <button id="resumeFromMenuButton" class="control-button">Resume Game</button>
            <button id="backToMainMenuButtonFromGame" class="control-button">Back to Main Menu</button>
        </div>

        <div id="high-score-modal" style="display: none;">
            <h3>New High Score!</h3>
            <p>Enter your name:</p>
            <input type="text" id="playerNameInput" maxlength="15" placeholder="Your Name">
            <button id="saveScoreButton">Save Score</button>
        </div>

        <div id="level-select-menu" class="menu" style="display: none;">
            <h1>Select Level</h1>
            <div id="level-options">
                </div>
            <button id="backToMainMenuButton">Back</button>
        </div>

        <div id="character-select-menu" class="menu" style="display: none;">
            <h1>Select Your Survivor</h1>
            <div id="character-options" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px;">
                <div class="character-card" data-character="johnny">
                    <h3>Johnny Wicked</h3>
                    <p>Classic survivor, balanced abilities.</p>
                    <p>Starting Weapon: Pistol</p>
                </div>
                <div class="character-card" data-character="dixie">
                    <h3>Dixie</h3>
                    <p>Dog whisperer, commands loyal companions.</p>
                    <p>Starting Weapon: Twin Uzis + 1 Dog Ally</p>
                </div>
            </div>
            <button id="backToStartMenuFromCharSelect">Back</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (will be initialized in init function)
        window.fb = {};

        window.initFirebase = async function() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. High score system will not function.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            window.fb.db = getFirestore(app);
            window.fb.auth = getAuth(app);
            window.fb.appId = appId; // Store appId for later use

            // Sign in anonymously if no custom token is provided
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(window.fb.auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    await signInAnonymously(window.fb.auth);
                    console.log("Signed in anonymously instead.");
                }
            } else {
                await signInAnonymously(window.fb.auth);
                console.log("Signed in anonymously.");
            }

            // Listen for auth state changes to ensure user is ready
            onAuthStateChanged(window.fb.auth, (user) => {
                if (user) {
                    window.fb.userId = user.uid;
                    console.log("Firebase user ready:", window.fb.userId);
                    // Load user's level scores once authenticated
                    window.loadUserLevelScore('hotel_lobby').then(score => {
                        window.highestHotelLobbyScore = score;
                        console.log("Loaded highest Hotel Lobby score:", window.highestHotelLobbyScore);
                    });
                    // Load 'the_park' score
                    window.loadUserLevelScore('the_park').then(score => {
                        window.highestTheParkScore = score;
                        console.log("Loaded highest The Park score:", window.highestTheParkScore);
                    });
                    // Display high scores on start menu after Firebase is initialized
                    window.displayHighScores('start-menu-high-scores-list');
                } else {
                    console.log("Firebase user not signed in.");
                    window.fb.userId = null; // Ensure userId is null if not authenticated
                }
            });
        };

        window.saveHighScoreFirebase = async function(name, score, time, level, levelId) {
            if (!window.fb.db || !window.fb.userId) {
                console.error("Firestore not initialized or user not authenticated.");
                return;
            }

            const highScoresCollection = collection(window.fb.db, `artifacts/${window.fb.appId}/public/data/highScores`);
            try {
                console.log(`[Firebase Save] Attempting to save score for name: ${name}, score: ${score}, levelId: ${levelId}`); // Added levelId
                await addDoc(highScoresCollection, {
                    name: name,
                    score: score,
                    survivalTime: time,
                    level: level,
                    levelId: levelId, // Save the level ID
                    timestamp: Date.now(),
                    userId: window.fb.userId
                });
                console.log("High score saved successfully to public high scores!");
            } catch (e) {
                console.error("Error adding document to public high scores: ", e);
            }
        };

        window.getHighScoresFirebase = async function() {
            if (!window.fb.db) {
                console.error("Firestore not initialized.");
                return [];
            }

            const highScoresCollection = collection(window.fb.db, `artifacts/${window.fb.appId}/public/data/highScores`);
            const q = query(highScoresCollection, orderBy("score", "desc"), limit(10));
            
            try {
                const querySnapshot = await getDocs(q);
                const highScores = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("[Firebase Get] Fetched high score data:", data);
                    highScores.push(data);
                });
                highScores.sort((a, b) => b.score - a.score); // Client-side sort just in case
                return highScores;
            } catch (e) {
                console.error("Error getting documents from public high scores: ", e);
                return [];
            }
        };

        window.saveUserLevelScore = async function(levelId, score) {
            if (!window.fb.db || !window.fb.userId) {
                console.error("Firestore not initialized or user not authenticated for private data.");
                return;
            }

            const userLevelScoreRef = doc(window.fb.db, `artifacts/${window.fb.appId}/users/${window.fb.userId}/levelScores`, levelId);
            try {
                const docSnap = await getDoc(userLevelScoreRef);
                let currentBestScore = 0;
                if (docSnap.exists()) {
                    currentBestScore = docSnap.data().highestScore || 0;
                }

                if (score > currentBestScore) {
                    await setDoc(userLevelScoreRef, { highestScore: score, timestamp: Date.now() });
                    console.log(`User's highest score for ${levelId} updated to ${score}.`);
                    // Update the global variable if it's for hotel lobby
                    if (levelId === 'hotel_lobby') {
                        window.highestHotelLobbyScore = score;
                    } else if (levelId === 'the_park') { // Update for 'the_park'
                        window.highestTheParkScore = score;
                    }
                } else {
                    console.log(`Current score ${score} is not higher than existing best ${currentBestScore} for ${levelId}.`);
                }
            } catch (e) {
                console.error(`Error saving user level score for ${levelId}: `, e);
            }
        };

        window.loadUserLevelScore = async function(levelId) {
            if (!window.fb.db || !window.fb.userId) {
                console.warn("Firestore not initialized or user not authenticated for private data. Returning 0 for level score.");
                return 0;
            }

            const userLevelScoreRef = doc(window.fb.db, `artifacts/${window.fb.appId}/users/${window.fb.userId}/levelScores`, levelId);
            try {
                const docSnap = await getDoc(userLevelScoreRef);
                if (docSnap.exists()) {
                    return docSnap.data().highestScore || 0;
                }
                return 0;
            } catch (e) {
                console.error(`Error loading user level score for ${levelId}: `, e);
            }
        };
    </script>

    <script>
        // Get canvas and UI elements from the DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const gameContainer = document.getElementById('gameContainer');
        const startMenu = document.getElementById('start-menu');
        const gameOverMenu = document.getElementById('game-over-menu');
        const messageBox = document.getElementById('message-box');
        const powerSelectionDiv = document.getElementById('power-selection');
        const ultimateButton = document.getElementById('ultimate-button');
        const highScoreModal = document.getElementById('high-score-modal');
        const playerNameInput = document.getElementById('playerNameInput');
        const saveScoreButton = document.getElementById('saveScoreButton');
        const highScoresList = document.getElementById('high-scores-list');
        const startMenuHighScoresList = document.getElementById('start-menu-high-scores-list'); // New element for start menu
        const pauseButton = document.getElementById('pauseButton'); 
        const menuButton = document.getElementById('menuButton');     
        const gameMenu = document.getElementById('game-menu');       
        const muteMusicButton = document.getElementById('muteMusicButton'); 
        const resumeFromMenuButton = document.getElementById('resumeFromMenuButton'); 
        const levelSelectButton = document.getElementById('levelSelectButton'); 
        const levelSelectMenu = document.getElementById('level-select-menu'); 
        const levelOptionsDiv = document.getElementById('level-options'); 
        const backToMainMenuButton = document.getElementById('backToMainMenuButton'); 
        const backToMainMenuButtonFromGame = document.getElementById('backToMainMenuButtonFromGame'); 
        const characterSelectMenu = document.getElementById('character-select-menu'); 
        const characterOptionsDiv = document.getElementById('character-options'); 
        const backToStartMenuFromCharSelect = document.getElementById('backToStartMenuFromCharSelect'); 
        const backToMainMenuButtonGameOver = document.getElementById('backToMainMenuButtonGameOver'); // New button

        const scoreDisplay = document.getElementById('score-display');
        const timeDisplay = document.getElementById('time-display');
        const levelDisplay = document.getElementById('level-display');
        const xpBar = document.getElementById('xp-bar');
        const ultimateBar = document.getElementById('ultimate-bar');

        // Mini-map elements
        const miniMapCanvas = document.getElementById('miniMapCanvas');
        const miniMapCtx = miniMapCanvas.getContext('2d');
        let miniMapScale = 1; // Will be calculated in init

        // Game state variables
        let gameRunning = false;
        let lastTime = 0;
        let deltaTime = 0;
        let score = 0;
        let survivalTime = 0;
        let ultimateCharge = 0;
        const ultimateMaxCharge = 100;
        let damageNumbers = [];
        let particles = []; 
        let gameWorld = {
            width: 3000, 
            height: 3000 
        };
        let gameSpeedMultiplier = 1; 
        let playerSpeedModifier = 1; 
        let projectileSpeedModifier = 1; 
        let bulletTimeActive = false; 
        let bulletTimeDuration = 0; 
        let spinningKnives = []; 
        
        let randomChestSpawnTimer = 0; 
        const RANDOM_CHEST_SPAWN_INTERVAL = 5; 
        const RANDOM_CHEST_SPAWN_CHANCE = 0.011; 

        let randomHeartSpawnTimer = 0; 
        const HEART_SPAWN_START_TIME = 180; 
        const HEART_SPAWN_INTERVAL = 60; 
        const HEART_SPAWN_CHANCE = 0.2; 

        let chests = []; 
        let drones = []; 
        let boomerangs = []; 

        // Camera for a larger game world
        let camera = {
            x: 0,
            y: 0,
            width: 900,
            height: 700,
            zoom: 0.8 
        };

        // Player object with stats and upgrades
        const initialPlayerX = gameWorld.width / 2;
        const initialPlayerY = gameWorld.height / 2;
        let player = {
            x: initialPlayerX,
            y: initialPlayerY,
            targetX: initialPlayerX,
            targetY: initialPlayerY,
            size: 20,
            color: '#6A808C', 
            baseColor: '#6A808C', 
            speed: 300, 
            health: 100, // This will be set based on character in startGame
            maxHealth: 100, // This will be set based on character in startGame
            xp: 0,
            nextLevelXp: 100,
            level: 1,
            stats: {
                damage: 20,
                attackSpeed: 10, 
                projectileSpeed: 400,
                pierce: 0,
                multiShot: 1,
                healthRegen: 0.1,
                magnet: 120, // INCREASED from 80
                damageReduction: 0, 
                spinningKnivesDamage: 0, 
                spinningKnivesCount: 0, 
                burstDamage: 0,
                burstProjectileCount: 0,
                droneCount: 0, 
                droneDamage: 0, 
                droneAttackSpeed: 0, 
                shotgunPellets: 0, 
                shotgunDamage: 0, 
                shotgunSpread: 0, 
                shotgunRange: 200 * 1.25, // Base range * 1.25
                dualUziActive: false, 
                dualUziFireRate: 0, 
                dualUziDamage: 0, 
                boomerangDamage: 0, 
                boomerangCount: 0, 
                boomerangCooldown: 4, 
                boomerangRange: 150, 
                boomerangSpeed: 400, 
                burstChargeDamage: 0, 
                burstChargeProjectileCount: 0,
                forcefieldActive: false, 
                forcefieldDamage: 0,     
                forcefieldRadius: 0,     
                leashWhipDamage: 0,
                leashWhipRange: 0, // NEW: Leash whip range
                leashWhipCooldown: 1.5, // Leash whip cooldown
                leashWhipTimer: 0, // Leash whip timer
                knifeDamage: 0, // New: Knife damage
                knifeCount: 0,  // New: Number of knives thrown
                knifeCooldown: 1.5, // New: Cooldown for knife throw
                swordDamage: 0, // New: Sword damage
                swordPierce: 0, // New: Sword pierce
                swordCooldown: 3, // New: Cooldown for sword throw
            },
            upgrades: {
                damage: 0,
                attackSpeed: 0,
                health: 0,
                speed: 0,
                pierce: 0,
                multiShot: 0,
                healthRegen: 0,
                magnet: 0,
                bulletproofSuit: 0, 
                ultimateRecharge: 0,
                burstShot: 0,
                spinningKnives: 0, 
                combatDrone: 0, 
                shotgun: 0, 
                shotgunRange: 0,
                dualUzi: 0,
                boomerang: 0, 
                burstCharge: 0, 
                forcefield: 0,           
                dogPack: 0,              
                dogBones: 0,             
                leashWhip: 0,            
                dogStrength: 0,          
                dogSpeed: 0,             
                knifeThrow: 0, // New: Knife Throw upgrade level
                swordThrow: 0, // New: Sword Throw upgrade level
            },
            burstChargeCooldown: 5, 
            burstChargeTimer: 0, 
            burstCooldown: 1,
            burstTimer: 0,
            shotgunTimer: 0, 
            dualUziTimer: 0, 
            boomerangTimer: 0, 
            lastX: initialPlayerX,
            lastY: initialPlayerY,
            animationFrame: 0,
            isMoving: false,
            vx: 0, 
            vy: 0,
            // New stats for shotgun range
            shotgunRange: 200,
        };

        // Other game variables...
        let enemies = [];
        let projectiles = [];
        let playerProjectiles = [];
        let xpOrbs = [];
        let powerups = [];
        let obstacles = [];
        let allyDogs = [];
        let currentCharacter = 'johnny'; 
        let currentLevelId = 'hotel_lobby'; 
        let isPaused = false;
        let isMenuOpen = false;
        let levelUpQueue = [];
        let isMusicMuted = false;
        let musicVolume = 0.5;
        let sfxVolume = 1.0;
        let playerSynth, enemyHitSynth, levelUpSynth, ultimateSynth, gameOverSynth, explosionSound, shootSynth, dogWhistleSynth; // Declare synths
        let backgroundMusicSequence;
        let bassSequence;
        let currentMusicPatternIndex = 0;
        const BACKGROUND_MUSIC_PATTERNS = [
            // Pattern 1:
            [{ note: 'C4', duration: '4n' }, { note: 'E4', duration: '4n' }, { note: 'G4', duration: '4n' }, { note: 'C5', duration: '4n' }],
            // Pattern 2:
            [{ note: 'D4', duration: '4n' }, { note: 'F4', duration: '4n' }, { note: 'A4', duration: '4n' }, { note: 'D5', duration: '4n' }],
            // Pattern 3:
            [{ note: 'C4', duration: '8n' }, { note: 'D4', duration: '8n' }, { note: 'E4', duration: '8n' }, { note: 'F4', duration: '8n' }, { note: 'G4', duration: '8n' }, { note: 'A4', duration: '8n' }, { note: 'B4', duration: '8n' }, { note: 'C5', duration: '8n' }],
        ];
        let lastUziSoundTime = 0;
        const UZI_SOUND_COOLDOWN = 0.05;

        // Temporary power-up state
        let temporaryPowerupActive = false;
        let temporaryPowerupDuration = 0;
        let temporaryPowerupType = '';
        let temporaryPowerupTimer = 0;

        // Player animation states
        const playerAnimations = {
            'johnny': {
                idle: [0],
                walk: [1, 0, 2, 0]
            },
            'dixie': {
                idle: [3],
                walk: [4, 3, 5, 3]
            }
        };

        // Image for pixel art
        const playerSpriteSheet = new Image();
        playerSpriteSheet.src = 'https://i.imgur.com/B7M88w8.png'; // Placeholder image URL

        // Power-up options with their effects and descriptions
        const POWER_OPTIONS = [
            { id: 'damageUp', name: 'Damage Up', description: 'Increase weapon damage.', effect: () => { player.stats.damage += 5; player.upgrades.damage++; }, maxLevel: 10, icon: 'ðŸ’¥' },
            { id: 'attackSpeedUp', name: 'Attack Speed Up', description: 'Increase fire rate.', effect: () => { player.stats.attackSpeed += 2; player.upgrades.attackSpeed++; }, maxLevel: 10, icon: 'â±ï¸' },
            { id: 'healthUp', name: 'Health Up', description: 'Increase max health.', effect: () => { player.maxHealth += 20; player.health += 20; player.upgrades.health++; }, maxLevel: 5, icon: 'â¤ï¸' },
            { id: 'speedUp', name: 'Speed Up', description: 'Increase player movement speed.', effect: () => { player.speed += 20; player.upgrades.speed++; }, maxLevel: 5, icon: 'ðŸ‘Ÿ' },
            { id: 'pierceUp', name: 'Piercing Shots', description: 'Bullets can hit more enemies.', effect: () => { player.stats.pierce += 1; player.upgrades.pierce++; }, maxLevel: 3, icon: ' xuyÃªn' },
            { id: 'multiShot', name: 'Multi-Shot', description: 'Fire an additional projectile.', effect: () => { player.stats.multiShot += 1; player.upgrades.multiShot++; }, maxLevel: 3, icon: 'âœ¨', characters: ['johnny'] },
            { id: 'healthRegen', name: 'Health Regen', description: 'Restore health over time.', effect: () => { player.stats.healthRegen += 0.2; player.upgrades.healthRegen++; }, maxLevel: 5, icon: 'ðŸ©¹' },
            { id: 'magnetUp', name: 'Magnet Range Up', description: 'Increases collection range for XP.', effect: () => { player.stats.magnet += 20; player.upgrades.magnet++; }, maxLevel: 5, icon: 'ðŸ§²' },
            { id: 'bulletproofSuit', name: 'Bulletproof Suit', description: 'Gain damage reduction.', effect: () => { player.stats.damageReduction += 0.05; player.upgrades.bulletproofSuit++; }, maxLevel: 5, icon: 'ðŸ›¡ï¸' },
            { id: 'ultimateRecharge', name: 'Ultimate Recharge', description: 'Ultimate charges faster.', effect: () => { ultimateChargePerHit += 0.05; player.upgrades.ultimateRecharge++; }, maxLevel: 5, icon: 'âš¡' },
            { id: 'spinningKnives', name: 'Spinning Knives', description: 'Summon spinning knives that damage enemies on contact.', effect: () => { player.stats.spinningKnivesCount++; player.stats.spinningKnivesDamage += 10; player.upgrades.spinningKnives++; }, maxLevel: 5, icon: 'ðŸ”ª' },
            { id: 'shotgun', name: 'Shotgun', description: 'Fire a cone of pellets.', effect: () => { player.stats.shotgunPellets = 5 + player.upgrades.shotgun * 2; player.stats.shotgunDamage = 15; player.stats.shotgunSpread = 0.5; player.upgrades.shotgun++; }, maxLevel: 5, icon: 'ðŸ”«', characters: ['johnny', 'dixie'] },
            { id: 'shotgunRange', name: 'Shotgun Range', description: 'Increase the range of your shotgun.', effect: () => { player.stats.shotgunRange += 50; player.upgrades.shotgunRange++; }, maxLevel: 5, icon: 'ðŸ”­', characters: ['johnny', 'dixie'] },
            { id: 'combatDrone', name: 'Combat Drone', description: 'Summon a combat drone that fires at enemies.', effect: () => { player.stats.droneCount++; player.stats.droneDamage += 10; player.stats.droneAttackSpeed += 2; player.upgrades.combatDrone++; }, maxLevel: 5, icon: 'ðŸš', characters: ['johnny', 'dixie'] },
            { id: 'dualUzi', name: 'Dual Uzi', description: 'Fire a stream of fast projectiles.', effect: () => { player.stats.dualUziActive = true; player.stats.dualUziFireRate = 0.05; player.stats.dualUziDamage += 5; player.upgrades.dualUzi++; }, maxLevel: 5, icon: 'ðŸ”«ðŸ”«', characters: ['johnny'] },
            { id: 'dogPack', name: 'Dog Pack', description: 'Summon an additional dog ally.', effect: () => { player.stats.dogPack++; player.upgrades.dogPack++; }, maxLevel: 4, icon: 'ðŸ•', characters: ['dixie'] },
            { id: 'dogBones', name: 'Dog Bones', description: 'Gives dog allies piercing bone projectiles.', effect: () => { player.stats.dogBones++; player.upgrades.dogBones++; }, maxLevel: 3, icon: 'ðŸ¦´', characters: ['dixie'] },
            { id: 'dogStrength', name: 'Dog Strength', description: 'Increase dog ally damage.', effect: () => { dogBaseDamage += 5; player.upgrades.dogStrength++; }, maxLevel: 5, icon: 'ðŸ’ª', characters: ['dixie'] },
            { id: 'dogSpeed', name: 'Dog Speed', description: 'Increase dog ally movement speed.', effect: () => { dogBaseSpeed += 20; player.upgrades.dogSpeed++; }, maxLevel: 5, icon: 'âš¡', characters: ['dixie'] },
            { id: 'forcefield', name: 'Forcefield', description: 'Create a damaging forcefield around the player.', effect: () => { player.stats.forcefieldActive = true; player.stats.forcefieldDamage += 5; player.stats.forcefieldRadius += 10; player.upgrades.forcefield++; }, maxLevel: 5, icon: 'ðŸŒ€' },
            { id: 'leashWhip', name: 'Leash Whip', description: 'Whip enemies with a spectral leash. Increases in range and damage.', effect: () => { player.stats.leashWhipDamage += 10; player.stats.leashWhipRange += 1; player.upgrades.leashWhip++; }, maxLevel: 5, icon: 'â›“ï¸', characters: ['dixie'] },
            { id: 'knifeThrow', name: 'Knife Throw', description: 'Throw a piercing knife.', effect: () => { player.stats.knifeDamage += 10; player.stats.knifeCount++; player.upgrades.knifeThrow++; }, maxLevel: 5, icon: 'ðŸ”ª' },
            { id: 'swordThrow', name: 'Sword Throw', description: 'Throw a powerful, piercing sword.', effect: () => { player.stats.swordDamage += 30; player.stats.swordPierce += 1; player.upgrades.swordThrow++; }, maxLevel: 3, icon: 'ðŸ—¡ï¸' },
        ]; let ultimateChargePerHit = 0.5; // Amount of ultimate charge gained per hit let dogBaseDamage = 15; let dogBaseSpeed = 150; let dogProjectileDamage = 0; let dogProjectileSpeed = 0; // Function to select a random power-up function getRandomPowerup() { const availablePowerups = POWER_OPTIONS.filter(power => { const isAvailable = !power.characters || power.characters.includes(currentCharacter); const isMaxed = player.upgrades[power.id] >= power.maxLevel; // Special condition for Shotgun and Dual Uzi const hasWeapon = player.upgrades.shotgun > 0 || player.upgrades.dualUzi > 0; const isWeaponUpgrade = power.id === 'shotgun' || power.id === 'dualUzi'; const isSpecificUpgrade = power.id === 'shotgunRange'; // New upgrade option if (isSpecificUpgrade) { // Only offer shotgun range if the player has a shotgun return isAvailable && !isMaxed && player.upgrades.shotgun > 0; } if (isWeaponUpgrade) { // Don't offer a new weapon if the player already has one (except for starting weapon...
// NEW CODE FOR LEASH WHIP START
let leashWhips = [];
function createLeashWhip(x, y, range, damage) {
    const whipDuration = 0.2; // The whip animation duration
    const whipAngle = Math.random() * Math.PI * 2; // Random direction
    const whipStartX = x;
    const whipStartY = y;
    const whipEndX = x + Math.cos(whipAngle) * range;
    const whipEndY = y + Math.sin(whipAngle) * range;

    leashWhips.push({
        x: whipStartX,
        y: whipStartY,
        endX: whipEndX,
        endY: whipEndY,
        range: range,
        damage: damage,
        duration: whipDuration,
        timer: 0,
        hasHit: false,
        angle: whipAngle,
    });
}
// NEW CODE FOR LEASH WHIP END


function init() {
            // Initial setup logic
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('click', handleTouchMove); // For mobile taps

            // Initialize audio context and synths
            initAudio();

            // Set up main menu UI
            startMenu.style.display = 'block';
            
            // Start the game loop
            requestAnimationFrame(gameLoop);
        }

        function initAudio() {
            // Check if Tone.js is available
            if (typeof Tone !== 'undefined') {
                Tone.start().then(() => {
                    console.log("AudioContext started successfully.");

                    // Master volume control
                    Tone.Master.volume.value = -10;

                    playerSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.5 },
                        volume: -15
                    }).toDestination();
                    
                    enemyHitSynth = new Tone.Synth({
                        oscillator: { type: 'square' },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 },
                        volume: -20
                    }).toDestination();

                    // MODIFIED: Level Up Synth for a clearer sound
                    levelUpSynth = new Tone.Synth({
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.5 },
                        volume: -10
                    }).toDestination();

                    ultimateSynth = new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.005, decay: 0.5, sustain: 0, release: 1 },
                        volume: -15
                    }).toDestination();

                    gameOverSynth = new Tone.Synth({
                        oscillator: { type: 'sawtooth' },
                        envelope: { attack: 0.1, decay: 0.5, sustain: 0.1, release: 1 },
                        volume: -10
                    }).toDestination();

                    explosionSound = new Tone.NoiseSynth({
                        noise: { type: 'pink' },
                        envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 },
                        volume: -15
                    }).toDestination();

                    shootSynth = new Tone.Synth({
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 },
                        volume: -20
                    }).toDestination();

                    dogWhistleSynth = new Tone.Synth({
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.05, decay: 0.3, sustain: 0, release: 0.5 },
                        volume: -15
                    }).toDestination();

                    // Setup background music sequences
                    backgroundMusicSequence = new Tone.Sequence((time, note) => {
                        playerSynth.triggerAttackRelease(note.note, note.duration, time);
                    }, BACKGROUND_MUSIC_PATTERNS[currentMusicPatternIndex], '4n').start(0);

                    // Bass sequence for deeper tones
                    const bassNotes = ['C2', 'E2', 'G2', 'C2'];
                    bassSequence = new Tone.Sequence((time, note) => {
                        playerSynth.triggerAttackRelease(note, '2n', time);
                    }, bassNotes, '2n').start(0);

                    Tone.Transport.loop = true;
                    Tone.Transport.loopEnd = '4m';
                    Tone.Transport.start();
                });
            } else {
                console.warn("Tone.js not loaded, audio will be disabled.");
            }
        }
        
        function setMusicVolume() {
            if (Tone.Master) {
                Tone.Master.volume.value = isMusicMuted ? -Infinity : Tone.dbToGain(musicVolume);
            }
        }
        
        function toggleMusicMute() {
            isMusicMuted = !isMusicMuted;
            setMusicVolume();
            muteMusicButton.textContent = isMusicMuted ? 'Unmute Music' : 'Mute Music';
        }

        // Event listeners
        document.getElementById('startButton').addEventListener('click', () => {
            startMenu.style.display = 'none';
            characterSelectMenu.style.display = 'block';
        });

        document.getElementById('levelSelectButton').addEventListener('click', () => {
            startMenu.style.display = 'none';
            levelSelectMenu.style.display = 'block';
            displayLevelOptions();
        });

        document.getElementById('backToMainMenuButton').addEventListener('click', () => {
            levelSelectMenu.style.display = 'none';
            startMenu.style.display = 'block';
            displayHighScores('start-menu-high-scores-list');
        });

        document.getElementById('restartButton').addEventListener('click', () => {
            startGame(currentLevelId);
        });

        document.getElementById('pauseButton').addEventListener('click', () => {
            isPaused = !isPaused;
        });

        document.getElementById('menuButton').addEventListener('click', () => {
            toggleGameMenu(true);
        });

        document.getElementById('muteMusicButton').addEventListener('click', toggleMusicMute);
        document.getElementById('resumeFromMenuButton').addEventListener('click', () => {
            toggleGameMenu(false);
            isPaused = false;
        });
        document.getElementById('backToMainMenuButtonFromGame').addEventListener('click', () => {
            toggleGameMenu(false);
            stopGame();
        });

        document.getElementById('ultimate-button').addEventListener('click', activateUltimate);
        document.getElementById('backToStartMenuFromCharSelect').addEventListener('click', () => {
            characterSelectMenu.style.display = 'none';
            startMenu.style.display = 'block';
        });
        document.getElementById('backToMainMenuButtonGameOver').addEventListener('click', () => {
            stopGame();
        });

        characterOptionsDiv.addEventListener('click', (e) => {
            const card = e.target.closest('.character-card');
            if (card) {
                currentCharacter = card.dataset.character;
                characterSelectMenu.style.display = 'none';
                // Transition to level select
                levelSelectMenu.style.display = 'block';
                displayLevelOptions();
            }
        });

        saveScoreButton.addEventListener('click', () => {
            const name = playerNameInput.value || 'Anonymous';
            window.saveHighScoreFirebase(name, score, survivalTime, player.level, currentLevelId);
            highScoreModal.style.display = 'none';
            displayHighScores('high-scores-list', currentLevelId); // Show updated scores
        });

        // Other utility functions
        function resizeCanvas() {
            const containerRatio = gameContainer.clientWidth / gameContainer.clientHeight;
            const gameRatio = 900 / 700;

            if (containerRatio > gameRatio) {
                // Container is wider, scale by height
                canvas.style.width = (gameContainer.clientHeight * gameRatio) + 'px';
                canvas.style.height = gameContainer.clientHeight + 'px';
                canvas.width = 900;
                canvas.height = 700;
            } else {
                // Container is taller or same aspect ratio, scale by width
                canvas.style.width = gameContainer.clientWidth + 'px';
                canvas.style.height = (gameContainer.clientWidth / gameRatio) + 'px';
                canvas.width = 900;
                canvas.height = 700;
            }
        }
        
        function handleMouseMove(e) {
            if (!gameRunning || isPaused || isMenuOpen) return;
            // Get the position of the mouse relative to the canvas
            const rect = canvas.getBoundingClientRect();
            player.targetX = player.x + (e.clientX - rect.left - canvas.clientWidth / 2) / camera.zoom;
            player.targetY = player.y + (e.clientY - rect.top - canvas.clientHeight / 2) / camera.zoom;
        }

        function handleTouchMove(e) {
            e.preventDefault(); // Prevent default browser actions
            if (!gameRunning || isPaused || isMenuOpen) return;
            const touch = e.touches[0];
            if (touch) {
                const rect = canvas.getBoundingClientRect();
                player.targetX = player.x + (touch.clientX - rect.left - canvas.clientWidth / 2) / camera.zoom;
                player.targetY = player.y + (touch.clientY - rect.top - canvas.clientHeight / 2) / camera.zoom;
            }
        }

        function startGame(levelId) {
            currentLevelId = levelId;
            resetGame();

            // Character-specific setup
            if (currentCharacter === 'dixie') {
                player.maxHealth = 120;
                player.health = 120;
                player.stats.attackSpeed = 15;
                // Add initial dogs
                for (let i = 0; i < 1; i++) {
                    allyDogs.push(new DogAlly(player.x, player.y));
                }
            } else { // johnny
                player.maxHealth = 100;
                player.health = 100;
                player.stats.attackSpeed = 10;
                // Add initial weapon
                playerProjectiles.push(new Projectile(player.x, player.y, 0, 0, player.stats.damage));
            }

            gameRunning = true;
            isPaused = false;
            levelUpQueue = [];
            
            startMenu.style.display = 'none';
            gameOverMenu.style.display = 'none';
            messageBox.style.display = 'none';
            gameMenu.style.display = 'none';
            levelSelectMenu.style.display = 'none';
            highScoreModal.style.display = 'none';
            document.getElementById('ui').style.display = 'block';

            // Start enemy spawning
            startSpawning(currentLevelId);
        }

        function stopGame() {
            gameRunning = false;
            isPaused = true;
            enemies = [];
            projectiles = [];
            playerProjectiles = [];
            xpOrbs = [];
            powerups = [];
            spinningKnives = [];
            drones = [];
            boomerangs = [];
            chests = [];
            allyDogs = [];
            stopSpawning();
            // Show main menu
            document.getElementById('ui').style.display = 'none';
            gameOverMenu.style.display = 'none';
            gameMenu.style.display = 'none';
            startMenu.style.display = 'block';
            displayHighScores('start-menu-high-scores-list');
        }

        function resetGame() {
            // Reset all game state variables to their initial values
            score = 0;
            survivalTime = 0;
            ultimateCharge = 0;
            player = {
                ...player,
                x: initialPlayerX,
                y: initialPlayerY,
                targetX: initialPlayerX,
                targetY: initialPlayerY,
                health: 100, // Will be set based on character
                maxHealth: 100, // Will be set based on character
                xp: 0,
                nextLevelXp: 100,
                level: 1,
                stats: {
                    damage: 20,
                    attackSpeed: 10,
                    projectileSpeed: 400,
                    pierce: 0,
                    multiShot: 1,
                    healthRegen: 0.1,
                    magnet: 120,
                    damageReduction: 0,
                    spinningKnivesDamage: 0,
                    spinningKnivesCount: 0,
                    burstDamage: 0,
                    burstProjectileCount: 0,
                    droneCount: 0,
                    droneDamage: 0,
                    droneAttackSpeed: 0,
                    shotgunPellets: 0,
                    shotgunDamage: 0,
                    shotgunSpread: 0,
                    shotgunRange: 200 * 1.25,
                    dualUziActive: false,
                    dualUziFireRate: 0,
                    dualUziDamage: 0,
                    boomerangDamage: 0, 
                    boomerangCount: 0, 
                    boomerangCooldown: 4, 
                    boomerangRange: 150, 
                    boomerangSpeed: 400,
                    burstChargeDamage: 0, 
                    burstChargeProjectileCount: 0,
                    forcefieldActive: false,
                    forcefieldDamage: 0,
                    forcefieldRadius: 0,
                    leashWhipDamage: 0,
                    leashWhipRange: 0, // Reset new stat
                    leashWhipCooldown: 1.5,
                    leashWhipTimer: 0,
                    knifeDamage: 0,
                    knifeCount: 0,
                    knifeCooldown: 1.5,
                    swordDamage: 0,
                    swordPierce: 0,
                    swordCooldown: 3,
                },
                upgrades: {
                    damage: 0,
                    attackSpeed: 0,
                    health: 0,
                    speed: 0,
                    pierce: 0,
                    multiShot: 0,
                    healthRegen: 0,
                    magnet: 0,
                    bulletproofSuit: 0,
                    ultimateRecharge: 0,
                    burstShot: 0,
                    spinningKnives: 0,
                    combatDrone: 0,
                    shotgun: 0,
                    shotgunRange: 0,
                    dualUzi: 0,
                    boomerang: 0,
                    burstCharge: 0,
                    forcefield: 0,
                    dogPack: 0,
                    dogBones: 0,
                    leashWhip: 0,
                    dogStrength: 0,
                    dogSpeed: 0,
                    knifeThrow: 0,
                    swordThrow: 0,
                },
                shotgunRange: 200,
                // Reset other timers and states
                burstChargeCooldown: 5, 
                burstChargeTimer: 0, 
                burstCooldown: 1,
                burstTimer: 0,
                shotgunTimer: 0, 
                dualUziTimer: 0, 
                boomerangTimer: 0,
                lastX: initialPlayerX,
                lastY: initialPlayerY,
                animationFrame: 0,
                isMoving: false,
                vx: 0,
                vy: 0,
            };

            enemies = [];
            projectiles = [];
            playerProjectiles = [];
            xpOrbs = [];
            powerups = [];
            spinningKnives = [];
            drones = [];
            boomerangs = [];
            chests = [];
            allyDogs = [];
            ultimateCharge = 0;
            ultimateChargePerHit = 0.5;
            dogBaseDamage = 15;
            dogBaseSpeed = 150;
            dogProjectileDamage = 0;
            dogProjectileSpeed = 0;
        }

        // Game loop
        function gameLoop(timestamp) {
            deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (gameRunning && !isPaused && !isMenuOpen) {
                update(deltaTime);
                draw();
            } else if (!gameRunning && !isMenuOpen) {
                drawMainMenu();
            } else if (isMenuOpen && isPaused) {
                // Draw the pause or game over menu on top
                draw(); // Keep drawing the last frame of the game
            }

            requestAnimationFrame(gameLoop);
        }
        
        function update(deltaTime) {
            survivalTime += deltaTime;
            updateUI();
            handleLevelUp();
            updatePlayer(deltaTime);
            updateAllyDogs(deltaTime);
            updateEnemies(deltaTime);
            updateSpinningKnives(deltaTime);
            updateDrones(deltaTime);
            updateBoomerangs(deltaTime);
            updateProjectiles(deltaTime);
            updatePlayerProjectiles(deltaTime);
            updateXpOrbs(deltaTime);
            updateLeashWhips(deltaTime); // NEW: Update leash whips
            
            // ... (other update logic)
            checkCollisions();
            spawnEnemies(deltaTime);
        }

        function draw() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Draw background
            drawBackground();
            // Translate the canvas based on the camera
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-camera.x, -camera.y);
            // Draw game objects
            drawMap();
            drawXpOrbs();
            drawPowerups();
            drawPlayer();
            drawAllyDogs();
            drawSpinningKnives();
            drawBoomerangs();
            drawDrones();
            drawEnemies();
            drawProjectiles();
            drawPlayerProjectiles();
            drawLeashWhips(); // NEW: Draw leash whips
            drawDamageNumbers(deltaTime);
            drawParticles(deltaTime);
            // Restore canvas state
            ctx.restore();
            // Draw UI elements
            updateMiniMap();
        }
        
        function drawLeashWhips() {
            leashWhips.forEach(whip => {
                ctx.beginPath();
                ctx.moveTo(whip.x, whip.y);
                ctx.lineTo(whip.endX, whip.endY);
                ctx.strokeStyle = `rgba(255, 255, 255, ${1 - (whip.timer / whip.duration)})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        function updateLeashWhips(deltaTime) {
            if (player.upgrades.leashWhip > 0) {
                player.stats.leashWhipTimer += deltaTime;
                if (player.stats.leashWhipTimer >= player.stats.leashWhipCooldown) {
                    // Reset timer
                    player.stats.leashWhipTimer = 0;
                    // Trigger the whip animation and attack
                    createLeashWhip(player.x, player.y, player.stats.leashWhipRange * 100, player.stats.leashWhipDamage);

                }
            }
            
            leashWhips = leashWhips.filter(whip => {
                whip.timer += deltaTime;
                if (whip.timer >= whip.duration) return false;

                // Collision detection for the whip
                if (!whip.hasHit) {
                    enemies.forEach(enemy => {
                        const whipLength = whip.range;
                        // Calculate vector from player to enemy
                        const dx = enemy.x - player.x;
                        const dy = enemy.y - player.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        // Check if enemy is within the whip's range and angle
                        if (dist <= whipLength + enemy.size) {
                            const angleToEnemy = Math.atan2(dy, dx);
                            const angleDiff = Math.abs(whip.angle - angleToEnemy);
                            
                            // Check if the enemy is in a narrow cone of the whip
                            const isWithinCone = angleDiff < 0.2 || angleDiff > Math.PI * 2 - 0.2; 
                            if (isWithinCone) {
                                // Whip hits enemy
                                enemy.takeDamage(whip.damage);
                                whip.hasHit = true; // Prevents hitting multiple times
                                enemyHitSynth.triggerAttackRelease('C4', '8n');
                            }
                        }
                    });
                }
                return true;
            });
        }


        // ... (other helper functions like drawPlayer, etc.)

        function showLevelUpScreen() {
            // NEW: Play level up sound before showing the screen
            if (!isMusicMuted && levelUpSynth) {
                levelUpSynth.triggerAttackRelease(['C5', 'G5'], '8n');
            }
            isPaused = true;
            isMenuOpen = true;
            messageBox.style.display = 'block';
            // Clear previous power-up options
            powerSelectionDiv.innerHTML = '';
            // Get available power-ups
            const availablePowerups = getRandomPowerups();
            // Create cards for each power-up
            availablePowerups.forEach(power => {
                const powerCard = document.createElement('div');
                powerCard.className = 'power-card';
                // Display power-up details
                powerCard.innerHTML = `
                    <h4>${power.icon} ${power.name} <span>Lvl ${player.upgrades[power.id]}</span></h4>
                    <p>${power.description}</p>
                `;
                powerCard.addEventListener('click', () => {
                    power.effect();
                    hideLevelUpScreen();
                });
                powerSelectionDiv.appendChild(powerCard);
            });
        }
        
        function hideLevelUpScreen() {
            isPaused = false;
            isMenuOpen = false;
            messageBox.style.display = 'none';
            // Check if more level-ups are queued
            if (levelUpQueue.length > 0) {
                // Wait a moment before showing the next one
                setTimeout(() => {
                    showLevelUpScreen();
                }, 500); 
            }
        }
        
        // ... (rest of the code)
        
        // Main initialization call
        window.onload = function() {
            initFirebase().then(() => {
                init();
            });
        };
    </script>
</body>
</html>
